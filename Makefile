# 
# Top Makefile
# ============
# 
# This is the top-level makefile of the project
# 
SHELL = bash
PYTHON_EXEC ?= python3
BENCHMARK_SUITE_NAME = simple_gates
RTL_LIST_YAML = rtl_list.yaml

.SILENT:

rtl_list:
# This command generates a list of RTL designs under a given specific benchmark suite name
# This list is used by regression test script as an input file
	echo "======== Create RTL file list for ${BENCHMARK_SUITE_NAME} ========"; \
	currDir=$${PWD} && cd ${BENCHMARK_SUITE_NAME} && \
	find . -name *.v > ${RTL_LIST_YAML} && \
	sed -i 's/$$/:/' ${RTL_LIST_YAML} && \
	cd $${currDir} \

compile:
# This command compiles the RTL designss under a given specific benchmark suite name
# This command uses the RTL list generated by the ``rtl_list`` target
	echo "======== Test RTL compilation for ${BENCHMARK_SUITE_NAME} ========"; \
	currDir=$${PWD} && cd ${BENCHMARK_SUITE_NAME} && \
	${PYTHON_EXEC} ../run_reg_test.py --type compile --file ${RTL_LIST_YAML} && \
	cd $${currDir} \

cocotb_test:
# This command run HDL simulations for the RTL designss with cocotb testbenches under a given specific benchmark suite name
# This command uses the RTL list generated by the ``rtl_list`` target
	echo "======== Run Cocotb tests for ${BENCHMARK_SUITE_NAME} ========"; \
	currDir=$${PWD} && cd ${BENCHMARK_SUITE_NAME} && \
	${PYTHON_EXEC} ../run_reg_test.py --type cocotb_test --file ${RTL_LIST_YAML} && \
	cd $${currDir} \

clean:
# This command removes all the intermediate files during rtl compilation and cocotb verification 
	echo "======== Remove all the iverilog outputs ========"; \
	find . -name '*.o' -delete
	echo "======== Remove all the cocotb tests ========"; \
	find . -type f -name '__pycache__' -delete
	find . -name 'results.xml' -delete
	find . -name 'cocotb_sim.log' -delete
	find . -type f -name 'sim_build' -delete
